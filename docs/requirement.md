# 주변 건물 분석 MVP 요구사항 (KISS)

## 🎯 프로젝트 개요
특정 주소 입력 시 반경 1km 내 건물 용도 분석으로 주거/상업 적합성 판단

## 📋 기능 요구사항

### 핵심 기능 (1개)
**GET /analyze?address={address}**

입력: "서울 강남구 역삼동 123" 또는 "삼성동 센트럴아이파크"

**성공 응답 (200)** - 현재 버전
```json
{
  "address": "서울 강남구 역삼동 123",
  "coordinates": {
    "lat": 37.5012,
    "lng": 127.0396
  },
  "analysis": {
    "total_score": 85.3,
    "grade": "A+",
    "living": 45.2,
    "transportation": 30.1,
    "leisure": 10.0,
    "recommend": "주거 최적"
  },
  "details": {
    "counts": {
      "medical": 12,
      "schools": 18,
      "convenience_stores": 25,
      "subway_stations": 3,
      "cafes": 15
    },
    "nearest": {
      "medical": { "name": "서울대병원", "distance": 150 },
      "school": { "name": "역삼초등학교", "distance": 200 }
    },
    "weighted_scores": {
      "living": 45.2,
      "transportation": 30.1,
      "leisure": 10.0
    }
  },
  "poi_list": [
    {
      "name": "서울대병원",
      "category_group_code": "HP8",
      "x": 127.0396,
      "y": 37.5012,
      "distance": 150,
      "address": "서울 강남구 역삼동 123-45"
    }
  ]
}
```

**에러 응답**
```json
// 400 - 잘못된 주소
{"error": "Invalid address format"}

// 404 - 주소 검색 실패
{"error": "Address not found"}

// 503 - 카카오 API 장애
{"error": "External API unavailable"}
```

### 출력필드 (현재 버전)

| 필드 | 내용 | 계산 방식 |
|------|------|----------|
| total_score | 종합 점수 (0-100) | 거리 기반 가중치 합산 후 정규화 |
| grade | 등급 (A+~F) | 점수 구간별 등급 부여 |
| living | 생활편의 점수 | 의료시설 + 학교 + 편의점 (거리 가중치 적용) |
| transportation | 교통접근성 점수 | 지하철역 (거리 가중치 × 3.0) |
| leisure | 여가문화 점수 | 카페 (거리 가중치 × 0.5) |
| recommend | 권장 용도 | A+/A: "주거 최적", B+/B: "주거 적합", 기타: 단계별 |

**카카오 Local API 카테고리 코드** (현재 버전)
```ruby
CATEGORIES = {
  medical: 'HP8',       # 병원
  school: 'SC4',        # 학교
  convenience: 'CS2',   # 편의점
  subway: 'SW8',        # 지하철역
  cafe: 'CE7'           # 카페
}

WEIGHTS = {
  medical: 2.0,
  school: 1.5,
  convenience_store: 0.3,
  subway: 3.0,
  cafe: 0.5
}

RADIUS = 1000  # 반경 1km (미터)
```

## 🛠 기술 스택

| 역할 | 선택 | 이유 |
|------|------|------|
| Backend | Ruby on Rails 7 (API-only) | 당신 익숙, 2시간 완성 |
| Database | ~~PostgreSQL~~ 없음 | ActiveRecord 미사용 (API 전용) |
| Geocoding | 카카오 Geocoding API | 무료, 정확 |
| POI 검색 | 카카오 Local API | 1km 카테고리 완벽 |
| 프론트엔드 | Kakao Maps SDK | 무료, 강력한 지도 기능 |
| 환경변수 관리 | dotenv-rails | API 키 보안 관리 |

**API 키 관리**
- 카카오 REST API 키: `KAKAO_API_KEY` 환경변수
- 카카오 JavaScript API 키: 지도 표시용
- 로컬: `.env` 파일 (`.gitignore` 필수)

---

## 📋 완료된 기능

### ✅ Phase 1: 기본 API 구현 (완료)
- 카카오 Geocoding API (주소 → 좌표)
- 카카오 Local API (POI 검색)
- 점수 계산 로직
- 에러 처리
- JSON API 응답

### ✅ Phase 2: 프론트엔드 및 UI/UX (완료)
**Kakao Maps 연동**
- 지도 인터페이스 구현
- 주소 입력 폼 및 엔터키 지원
- 검색 위치 마커 표시 (빨간색)
- POI 카테고리별 색상 구분 마커
- 검색 반경 1km 원 표시 (보라색, 반투명)

### ✅ Phase 3: 점수 로직 대폭 개선 (완료)
**거리 기반 가중치 시스템**
- 거리에 따른 점수 감쇠 적용 (가까울수록 높은 점수)
- 카테고리별 가중치 설정 (병원 2.0, 지하철 3.0 등)

**점수 체계 개편**
- 0-100점 정규화
- A+~F 등급 시스템 (A+: 80~100점)
- 카테고리별 점수 분리
  - 🏠 생활편의 (의료·교육·편의점)
  - 🚇 교통접근성 (지하철역)
  - ☕ 여가문화 (카페)

**카테고리 확장**
- 기존: 병원(HP8), 학교(SC4), 공장(FD6)
- 현재: 병원(HP8), 학교(SC4), 편의점(CS2), 지하철역(SW8), 카페(CE7)

### ✅ Phase 4: 검색 기능 개선 (완료)
**지명 검색 지원**
- 주소 검색 실패 시 키워드 검색 자동 fallback
- 건물명, 랜드마크 검색 가능
  - ✅ "삼성동 센트럴아이파크"
  - ✅ "강남역"
  - ✅ "코엑스"

### ✅ Phase 5: 인터랙티브 기능 (완료)
**마커 클릭 기능**
- 시설 마커 클릭 시 인포윈도우 표시 (상호명, 주소, 카테고리)
- 오른쪽 패널에 선택된 시설 상세 정보 표시
- X 버튼으로 닫기 가능

**시설 목록 UI**
- 카테고리별 전체 시설 목록 표시
- 거리 가까운 순 자동 정렬
- 시설 항목 클릭 시 지도 자동 이동 및 줌인
- 호버 효과 및 시각적 피드백

### ✅ Phase 6: 기술 최적화 (완료)
- ActiveRecord 의존성 제거 (API 전용 서버)
- POI 상세 정보 반환 (이름, 좌표, 거리, 주소)
- 카테고리별 색상 범례 추가
- DOM 요소 직접 생성으로 이벤트 핸들링 개선

---

## 🚀 다음 단계 (선택사항)

### 1. ~~엑셀 파일 파싱 - 기부채납 공공시설 데이터 활용~~ ✅ **완료**
- ✅ `ExcelParser` 서비스: 엑셀 데이터 파싱 및 정규화
- ✅ `FacilityDataLoader` 서비스: 기존 시설 데이터 로드 및 통계
- ✅ Roo gem 활용 (엑셀 파일 읽기)
- ✅ 헤더 자동 인식 및 정규화 (시설명, 카테고리, 면적, 위치 등)
- ✅ 좌표 기반 거리 계산 (Haversine 공식)
- ✅ 시설 유형별 그룹화 및 통계 제공

**통합 기능**
- ✅ `AreaAnalyzer`에 기존 시설 데이터 자동 로드
- ✅ 반경 500m 내 기존 시설 카운트
- ✅ 시설 유형별 통계 (총 개수, 인근 개수, 최근접 거리)
- ✅ `PublicFacilityRecommender`에 엑셀 데이터 기반 감점 로직 추가
  - POI 기반 감점 (카카오 API 데이터)
  - 엑셀 기반 감점 (기부채납 실제 시설)
  - 최대 30% 감점 (시설 3개 이상 시)

**API 응답 확장**
```json
{
  "existing_facilities": {
    "total_count": 42,
    "nearby_count": 8,
    "by_type": {
      "어린이놀이터": {
        "total": 12,
        "nearby": 3,
        "nearest_distance": 280
      },
      "공원": {
        "total": 5,
        "nearby": 1,
        "nearest_distance": 450
      }
    }
  }
}
```

**신규 파일**
- `app/services/excel_parser.rb`: 엑셀 파싱 엔진
- `app/services/facility_data_loader.rb`: 데이터 로더 및 통계
- 데이터 소스: `docs/기부채납 공공시설 - 수기.xls`

### 2. Render 배포 - 실제 서비스 운영
- `render.yaml` 작성
- 환경변수 설정 (KAKAO_API_KEY)
- 배포 URL 확인

### 3. ~~프론트엔드 추가 - 지도에 시각화~~ ✅ **완료**
- ✅ Kakao Maps API 연동
- ✅ 주소 입력 폼
- ✅ 결과를 지도에 마커 표시
- ✅ POI 카테고리별 색상 구분
- ✅ 검색 반경 원 표시
- ✅ 인터랙티브 마커 및 시설 목록

### 4. ~~점수 로직 개선~~ ✅ **완료**
- ✅ 거리 가중치 적용 (가까울수록 높은 점수)
- ✅ 추가 카테고리 (편의점, 지하철역, 카페)
- ✅ 점수 범위 정규화 (0-100점)
- ✅ 상세 분석 리포트
- ✅ A+~F 등급 시스템

### 5. 가중치 튜닝 - 실제 데이터로 최적화
- 엑셀 데이터 기반 가중치 조정
- 실제 기부채납 사례 분석
- 점수 체계 검증 및 개선

### 6. 슬라이더 UI - 사용자 맞춤 가중치 조정
- 프론트엔드에 슬라이더 추가
- 실시간 점수 재계산
- 민감도 분석 기능

### 7. 캐싱 추가 - 성능 개선
- Redis 연동
- 동일 주소 요청 캐싱 (TTL: 24시간)
- API 호출 횟수 절감

### 8. 테스트 작성 - 안정성 확보
- RSpec 설정
- Service 단위 테스트
- Controller 통합 테스트
- API Mock 처리

### 9. 기능 확장
- 여러 주소 일괄 분석 (CSV 업로드)
- 분석 결과 저장 및 이력 조회
- 비교 기능 (A vs B 주소)
- PDF 리포트 생성

---

### ✅ Phase 7: 공공시설 용도 순위화 시스템 (완료)
**주변 상권/건물 용도 기반 공공시설 추천**
- 카카오 API 18개 카테고리 전체 활용 (기존 5개 → 18개)
  - 기존: HP8, SC4, CS2, SW8, CE7
  - 추가: MT1(대형마트), PS3(어린이집), AC5(학원), PK6(주차장), OL7(주유소), BK9(은행), CT1(문화시설), AG2(중개업소), PO3(공공기관), AT4(관광명소), AD5(숙박), FD6(음식점), PM9(약국)

**3층 지표 구조**
- 상위 지표 4개 (카테고리 → 상위지표 → 시설적합도)
  - 🏪 상권 활력도: 음식점, 카페, 대형마트, 편의점, 은행
  - 🏠 주거 수요: 학교, 병원, 어린이집, 약국, 학원
  - 🚇 교통 접근성: 지하철역, 주차장, 주유소
  - 🎭 문화/공공: 문화시설, 공공기관, 관광명소, 숙박

**공공시설 10종 추천 알고리즘**
- 주민센터, 도서관, 어린이집, 체육시설, 경로당, 주차장, 공원, 복지관, 청소년수련관, 보건소
- 각 시설별 최적 환경 규칙 정의 (config/public_facilities.yml)
- 기존 시설 밀집도 기반 감점 로직
- Top 5 순위 + 근거 표시

**신규 서비스 객체**
- `IndicatorCalculator`: 상위 지표 계산
- `PublicFacilityRecommender`: 시설 적합도 점수 및 순위

**API 응답 확장**
```json
{
  "area_indicators": {
    "commercial_vitality": 72.5,
    "residential_demand": 88.3,
    "transportation": 91.0,
    "culture_public": 45.2
  },
  "recommended_public_facilities": [
    {
      "rank": 1,
      "facility_type": "주민센터",
      "score": 92.3,
      "reason": "교통 접근성 우수(91.0점), 주거 수요 양호(88.3점)"
    }
  ]
}
```

**UI 개선**
- 📈 지역 특성 분석 섹션
- 🏗️ 추천 공공시설 순위 표시 (금·은·동 메달 디자인)
- 각 시설별 점수, 설명, 추천 근거 시각화

---

### ✅ Phase 8: 엑셀 파일 파싱 및 기존 시설 통합 (완료)
**기부채납 공공시설 데이터 활용**
- Roo gem 기반 엑셀 파일 파싱
- 헤더 자동 인식 및 정규화
- 시설 유형별 데이터 그룹화
- Haversine 공식 기반 거리 계산

**신규 서비스 객체**
- `ExcelParser`: 엑셀 파일 읽기 및 데이터 정규화
  - 다양한 헤더 형식 지원 (시설명/명칭, 면적/규모 등)
  - 날짜 형식 자동 파싱
  - 좌표 데이터 추출 및 통합
- `FacilityDataLoader`: 데이터 로드 및 통계 계산
  - 시설 유형별 그룹화
  - 주변 시설 개수 계산 (반경 500m)
  - 최근접 거리 계산
  - 카테고리 정규화 (YAML과 매칭)

**AreaAnalyzer 통합**
- 초기화 시 엑셀 데이터 자동 로드
- 분석 결과에 기존 시설 통계 포함
- existing_facilities 필드 추가

**PublicFacilityRecommender 개선**
- 이중 감점 시스템
  1. POI 기반 감점 (카카오 API)
  2. 엑셀 기반 감점 (기부채납 실제 시설, 최대 30%)
- 추천 근거에 기부채납 시설 정보 표시
- 시설 유형 매핑 자동화

**데이터 구조**
```ruby
{
  "어린이놀이터" => [
    {
      name: "○○놀이터",
      category: "어린이놀이터",
      area: 500.0,
      location: "서울시 강남구...",
      coordinates: { lat: 37.123, lng: 127.456 }
    }
  ]
}
```

---

### ✅ Phase 9: 상세 분석 보고서 생성 시스템 (완료)
**공공시설 추천에 대한 포괄적 근거 보고서**
- 6개 섹션으로 구성된 전문가급 분석 리포트
- 실시간 자동 생성 및 프론트엔드 렌더링

**보고서 구성**
1. **📍 분석 요약**
   - 분석 위치 및 일시
   - 최우선 추천 시설 및 점수
   - 지역 최강 특성 지표

2. **🏗️ 시설별 상세 분석** (Top 5)
   - 점수 계산 과정 투명화
     - 기본 점수 산출
     - 상위 지표별 기여도 (%, 점수, 가중치)
     - 감점 요인 상세 (POI 감점 + 엑셀 감점)
   - 입지 적합성 분석
     - 강점/약점 분석
     - 경쟁 시설 현황
     - 종합 평가
   - 실행 가능성 평가
     - 가능성 수준 (높음/중간/낮음)
     - 기존 시설 영향도
     - 권장사항

3. **🌍 지역 특성 종합 분석**
   - 지역 유형 분류 (주거/상업/교통/복합)
   - 개발 잠재력 평가
   - POI 분포 및 밀집도
   - 기존 시설 현황 및 포화도
   - 인구 밀도 추정

4. **📈 점수 분포 분석**
   - 상위 3개 시설 점수 비교
   - 점수 분포 (우수/양호/보통/미흡)
   - 상위 지표별 영향력 분석

5. **⚖️ 비교 분석**
   - 1위 vs 최하위 격차 분석
   - 카테고리별 리더 시설
   - 경쟁도 분석 (평균, 표준편차)

6. **💡 결론 및 제안**
   - 최우선 추천 및 근거
   - 대안 옵션 (2-3순위)
   - 주요 고려사항
   - 다음 단계 액션 플랜
     - 주민 의견 수렴
     - 부지 선정 및 타당성 검토
     - 예산 편성
     - 설계 및 인허가

**신규 서비스 객체**
- `FacilityReportGenerator`: 상세 보고서 생성 엔진
  - 6개 섹션 자동 생성
  - 통계 분석 (평균, 표준편차, 분포)
  - 비즈니스 로직 기반 인사이트 도출

**프론트엔드 UI**
- 섹션별 색상 테마
  - 요약: 보라색 그라디언트
  - 시설별 분석: 등급별 색상 (S/A+: 녹색, A/B+: 주황, C 이하: 빨강)
  - 지역 특성: 파란색 테마
  - 점수 분포: 주황색 테마
  - 비교 분석: 녹색 테마
  - 결론: 핑크 그라디언트
- 아코디언 스타일 상세 정보
- 모바일 반응형 디자인

**API 응답 확장**
```json
{
  "facility_report": {
    "summary": { /* 요약 정보 */ },
    "detailed_recommendations": [ /* 시설별 상세 */ ],
    "area_analysis": { /* 지역 특성 */ },
    "scoring_breakdown": { /* 점수 분해 */ },
    "comparative_analysis": { /* 비교 분석 */ },
    "conclusion": { /* 결론 및 제안 */ }
  }
}
```

**데이터 인사이트**
- 점수 계산 과정 완전 투명화
- 감점 로직 이유 및 영향도 표시
- 실행 가능성 평가 (현실성 검토)
- 지역 유형 자동 분류
- 개발 잠재력 정량화

---

## 🎊 **축하합니다! 풀스택 MVP + 공공시설 추천 시스템 + 실제 데이터 통합 + 전문가급 보고서 완성!**

### 주요 성과
- ✅ 실시간 주변시설 분석 API (18개 카테고리)
- ✅ 인터랙티브 지도 UI
- ✅ 정교한 점수 시스템 (3층 구조)
- ✅ 공공시설 용도 순위화 알고리즘
- ✅ 실제 기부채납 시설 데이터 통합
- ✅ 이중 검증 시스템 (POI + 엑셀)
- ✅ 포괄적 분석 보고서 자동 생성
- ✅ 의사결정 지원 시스템 (6개 섹션)
- ✅ 사용자 친화적 UX
- ✅ 확장 가능한 아키텍처
